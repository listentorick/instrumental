
var Instrumental = (function () {

	var escapeWrapper = window.encodeURIComponent || escape;

	function isDefined(property) {
		return typeof property !== 'undefined';
	}
		
	function Recorder(siteId) {
	
		var configRecordUrl = "http://instrumental:100001/record";
		var configCustomUrl;
		var configTitle = document.title;
		var configCaptureTimeout = 500;
	
		/*
		* Get page referrer
		*/
		function getReferrer() {
			var referrer = '';
			try {
				referrer = top.document.referrer;
			} catch (e) {
				if (parent) {
					try {
						referrer = parent.document.referrer;
					} catch (e2) {
						referrer = '';
					}
				}
			}
			if (referrer === '') {
				referrer = document.referrer;
			}

			return referrer;
		}
		
		/*
		* We use a GET to send our data to the server
		*/
		function capture(url, configCaptureTimeout) {
			var image = new Image(1, 1);
			image.onLoad = function () { };
			image.src = url;
		}
		
		function constructRequestUrl(request) {
			return configRecordUrl + '?' + request;
		}
	
		/*
		* Returns the URL to call piwik.php, 
		* with the standard parameters (plugins, resolution, url, referer, etc.)
		*/
		function getBaseRequest() {
			var i, now, request;
			now = new Date();
			request = 'idsite=' + siteId +
					'&url=' + escapeWrapper(isDefined(configCustomUrl) ? configCustomUrl : document.location.href) +
					'&urlref=' + escapeWrapper(pageReferrer);

			request =  constructRequestUrl(request);
			return request;
		}
	
		/*
		* Log the page view / visit
		*/
		function recordPageView(customTitle) {
			var request = getBaseRequest();
			request += '&urlref=' + escapeWrapper(pageReferrer); 
			request += '&action_name=' + escapeWrapper(isDefined(customTitle) ? customTitle : configTitle);
			capture(request, configCaptureTimeout);
		}

		var pageReferrer = getReferrer();
	
		return {
			recordPageView: recordPageView
		};
	}
	
	function getRecorder(siteId) {
		return new Recorder(siteId);
	}

	return {
		getRecorder:getRecorder
	};

})();